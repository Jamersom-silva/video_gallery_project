<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Galeria de Mídia</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen p-6">
  <div class="max-w-5xl mx-auto">

    <!-- Cabeçalho -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">Galeria de Mídia</h1>
      <div>
        <span id="me" class="mr-4"></span>
        <button id="btn-logout" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded">Logout</button>
      </div>
    </div>

    <!-- Formulário de Upload -->
    <section class="bg-slate-800 p-4 rounded-lg mb-6">
      <form id="uploadForm" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
        <div class="md:col-span-2">
          <label class="block text-sm text-slate-300">Título</label>
          <input id="title" class="mt-1 w-full rounded p-2 bg-slate-700 border border-slate-600" placeholder="Ex: Minha viagem" />
        </div>
        <div class="flex flex-col gap-3">
          <label class="block text-sm text-slate-300">Escolher arquivo</label>
          <input id="fileInput" type="file" accept="video/*,image/*" class="text-slate-200" />
          <button id="uploadBtn" class="bg-emerald-500 text-black px-4 py-2 rounded font-semibold">Adicionar</button>
        </div>
      </form>
    </section>

    <!-- Galeria -->
    <section>
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">Minha galeria</h2>
        <div class="text-sm text-slate-400">Total: <span id="count">0</span></div>
      </div>
      <div id="gallery" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
      <p id="emptyMsg" class="text-slate-500 mt-4">Nenhuma mídia ainda. Faça upload para ver aqui.</p>
    </section>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center p-6">
    <div class="bg-slate-900 rounded-lg max-w-3xl w-full p-4">
      <div class="flex justify-between items-start">
        <div>
          <h3 id="modalTitle" class="text-lg font-bold"></h3>
          <p id="modalDesc" class="text-sm text-slate-400"></p>
        </div>
        <div class="flex gap-2">
          <button id="closeModal" class="bg-slate-700 px-3 py-1 rounded">Fechar</button>
        </div>
      </div>
      <div class="mt-4">
        <img id="modalImage" class="w-full rounded hidden" />
        <video id="modalVideo" controls class="w-full rounded bg-black hidden"></video>
      </div>
    </div>
  </div>

  <!-- Template da Galeria -->
  <template id="cardTpl">
    <div class="bg-slate-800 rounded overflow-hidden shadow hover:shadow-lg transition cursor-pointer">
      <div class="relative h-48 bg-black flex items-center justify-center overflow-hidden">
        <img class="w-full h-full object-cover hidden" />
        <video class="w-full h-full object-cover hidden" muted playsinline preload="metadata"></video>
      </div>
      <div class="p-3">
        <h4 class="font-semibold text-lg truncate"></h4>
        <p class="text-sm text-slate-400 truncate mt-1"></p>
      </div>
    </div>
  </template>

<script>
const API = 'https://video-gallery-project-1.onrender.com'; // URL do backend Render
const token = localStorage.getItem('token');
const username = localStorage.getItem('username');

if(!token) window.location.href = 'login.html';
document.getElementById('me').textContent = username;

document.getElementById('btn-logout').onclick = () => {
  localStorage.removeItem('token');
  localStorage.removeItem('username');
  window.location.href = 'login.html';
}

const uploadForm = document.getElementById('uploadForm');
const fileInput = document.getElementById('fileInput');
const titleInput = document.getElementById('title');
const gallery = document.getElementById('gallery');
const countSpan = document.getElementById('count');
const emptyMsg = document.getElementById('emptyMsg');
const modal = document.getElementById('modal');
const modalVideo = document.getElementById('modalVideo');
const modalImage = document.getElementById('modalImage');
const modalTitle = document.getElementById('modalTitle');
const modalDesc = document.getElementById('modalDesc');
const closeModal = document.getElementById('closeModal');

uploadForm.addEventListener('submit', async e => {
  e.preventDefault();
  const file = fileInput.files[0];
  if(!file){ alert('Escolha um arquivo'); return; }

  const formData = new FormData();
  formData.append('file', file);
  formData.append('title', titleInput.value);

  try {
    const res = await fetch(`${API}/media/upload`, {
      method: 'POST',
      headers: {'Authorization': `Bearer ${token}`},
      body: formData
    });
    const data = await res.json();
    if(data.success){
      titleInput.value=''; fileInput.value='';
      await renderGallery();
    } else {
      alert(data.message || 'Erro no upload');
    }
  } catch(err){
    alert('Erro ao conectar ao servidor');
    console.error(err);
  }
});

closeModal.addEventListener('click', () => {
  modal.classList.add('hidden');
  modalVideo.pause();
  modalVideo.src = '';
  modalImage.src='';
});

async function renderGallery(){
  try {
    const res = await fetch(`${API}/media/list`, { headers: {'Authorization': `Bearer ${token}`} });
    const items = await res.json();
    gallery.innerHTML='';
    countSpan.textContent = items.length;
    emptyMsg.style.display = items.length ? 'none' : 'block';
    const tpl = document.getElementById('cardTpl');

    items.forEach(item => {
      const el = tpl.content.cloneNode(true);
      const img = el.querySelector('img');
      const video = el.querySelector('video');
      const h4 = el.querySelector('h4');
      const p = el.querySelector('p');

      h4.textContent = item.title;
      p.textContent = '';

      if(item.type==='image'){
        img.src = item.url;
        img.classList.remove('hidden');
      } else {
        video.src = item.url;
        video.classList.remove('hidden');
      }

      const downloadBtn = document.createElement('button');
      downloadBtn.textContent = 'Baixar';
      downloadBtn.className = 'mt-2 bg-blue-500 px-3 py-1 rounded text-sm';
      downloadBtn.onclick = (e) => {
        e.stopPropagation();
        window.open(`${API}/media/download/${item.id}?token=${token}`, '_blank');
      };
      el.querySelector('.p-3').appendChild(downloadBtn);

      el.querySelector('div.bg-slate-800').onclick = () => openModal(item);

      gallery.appendChild(el);
    });
  } catch(err){
    alert('Erro ao carregar galeria');
    console.error(err);
  }
}

function openModal(item){
  modal.classList.remove('hidden');
  modalTitle.textContent = item.title;
  modalDesc.textContent = '';
  if(item.type==='image'){
    modalImage.src = item.url;
    modalImage.classList.remove('hidden');
    modalVideo.classList.add('hidden');
  } else {
    modalVideo.src = item.url;
    modalVideo.classList.remove('hidden');
    modalImage.classList.add('hidden');
  }
}

renderGallery();
</script>
</body>
</html>
